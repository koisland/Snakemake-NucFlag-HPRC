# HPRC NucFlag
[NucFlag](https://github.com/logsdon-lab/NucFlag) is a tool to flag regions of the genome that are potentially misassembled based on read alignments.

# Inputs
* Alignment (BAM) against a genome assembly. Used same BAM as flagger.
    * https://github.com/human-pangenomics/hprc_intermediate_assembly/blob/main/data_tables/assembly_qc/flagger/flagger_hifi_processing_metadata_v0.1.csv
* Configuration file.
    * https://github.com/koisland/Snakemake-NucFlag-HPRC/blob/main/config/nucflag.toml
* (Optional) BED file with RM tracks. Visualization only.
    * https://github.com/human-pangenomics/hprc_intermediate_assembly/tree/main/data_tables/annotation/repeat_masker

# Outputs
These were generated by custom scripts.
* BigWig
    * First most common base
    * Second most common base
* BED
    * Potentially misassembled regions with abnormal read coverage.
* Plots
    * Plots showing first and second most common base and potential misassemblies flagged.

# Parameters
* See descriptions here, https://github.com/logsdon-lab/NucFlag/wiki/2.-Configuration

# Methods
1. Generate a read pileup of the first and second most common base frequencies per position in the genome.
2. Calculate the heterozygous base ratio.   
3. Call peaks in both first and second signals based on proportion relative to mean within region.
4. Filter peaks with the most abnormal read alignment coverage based on given thresholds.
5. Overlap peaks to determine misassembly classifications.

# Misassemblies
MISJOIN (orange)
* Drop in first most common base coverage or a coverage gap.
* This region has minimal to no reads supporting it or is a scaffold.
* Can overlap region with secondary base coverage.

COLLAPSE (green)
* Collapse with no variants.

COLLAPSE_VAR (blue)
* Collapse with variants. Overlaps region with high secondary base coverage.

COLLAPSE_OTHER (red)
* Region with high het ratio.

HET (teal)
* Possible heterozygous (het) site.
* Determined by the het ratio, the coverage of the second most common base divided by the first most common base coverage plus the second most common base coverage.


# Credits
Keisuke K. Oshima <Keith.Oshima@Pennmedicine.upenn.edu>
